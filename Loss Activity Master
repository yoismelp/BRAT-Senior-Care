Sub Button1_Click()
    Application.Calculation = xlCalculationManual
    Application.ScreenUpdating = False
    Sheets("Export Data").Visible = True
    
    Dim CURRENT_USER As String
        CURRENT_USER = Application.UserName
    Dim TimeStamp As String
        TimeStamp = Format(Now(), "yyyyMMddhhmmss")
    Dim ENTRY_DATE As String
        ENTRY_DATE = Format(Now, "YYYYMMDD hh:mm:ss  AM/PM")
    Dim filePat As String
        filePath = Application.ActiveWorkbook.FullName
    
    Sheets("Risk Analysis").Select
    
    Dim BRAT_NAME As String
        BRAT_NAME = Range("B5").Value
    Dim VERSION As String
        VERSION = Range("E7").Value
        
    Sheets("Loss Listing").Select
    
    Dim sharePointURL As String
    'DEV
        'sharePointURL = "https://bowheadsi.sharepoint.com/sites/DevDataVault/Shared%20Documents/Policy%20Processing/BRAT%20-%20Losses%20Export/"
    'PROD
         sharePointURL = "https://bowheadsi.sharepoint.com/sites/DataVault/Shared%20Documents/Policy%20Processing/BRAT%20-%20Losses%20Export/"
    
    'AccountInfoTable
    AccountInfoTableExportHandler ENTRY_DATE, CURRENT_USER, "AccountInfo", TimeStamp, sharePointURL, BRAT_NAME, VERSION
    
    'ExposureTable
    ExposureTableExportHandler ENTRY_DATE, CURRENT_USER, "ExposureTable", TimeStamp, sharePointURL, BRAT_NAME, VERSION
              
    'TowerTable
    DataExportHandler ENTRY_DATE, CURRENT_USER, "TowerTable", TimeStamp, sharePointURL, BRAT_NAME, VERSION
    
    'LocationTable
    DataExportHandler ENTRY_DATE, CURRENT_USER, "LocationTable", TimeStamp, sharePointURL, BRAT_NAME, VERSION
    
    'LossListingTable
    LossListingTableHandler sharePointURL, BRAT_NAME, VERSION
    
    Sheets("Export Data").Visible = False
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
End Sub

Sub AccountInfoTableExportHandler(EntryDate, EntryUser, TableName, TimeStamp, sharePointURL, BRAT_NAME, VERSION)
    Sheets("Export Data").Select
    
    Dim headersRowNumber As Integer
    Range(TableName + "[[#Headers],['UploadID]]").Select
        headersRowNumber = ActiveCell.Row
        
    Dim col As Variant

    With Sheets("Export Data") '<--| reference relevant worksheet
        col = Application.Match("EntryBy", .Rows(4), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With

    With Sheets("Export Data") '<--| reference relevant worksheet
        col = Application.Match("EntryDate", .Rows(4), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With

    With Sheets("Export Data") '<--| reference relevant worksheet
        col = Application.Match("VariableValueExport", .Rows(4), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With

    Sheets("Export Data").Select
    Range(TableName).Select
    'START Add EntryDate and EntryBy
    Selection.End(xlToRight).Offset(-1, 1).Select
    
    ActiveCell.EntireColumn.Select
    ActiveCell.Activate

    Selection.Insert Shift:=xlToRight
    Selection.Insert Shift:=xlToRight
    Selection.Insert Shift:=xlToRight
    
    Range(TableName).Select
    Selection.End(xlToRight).Offset(-1, 1).Select
    
    Application.CutCopyMode = False
    ActiveCell.FormulaR1C1 = "EntryBy"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "EntryDate"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "VariableValueExport"
    
    'Values
    ActiveCell.Offset(1, -2).Select
    ActiveCell.FormulaR1C1 = EntryUser
    ActiveCell.Select
    Selection.Copy
    Range(Selection, Selection.End(xlDown)).Select
    ActiveSheet.Paste
    
    ActiveCell.Offset(0, 1).Select
    Application.CutCopyMode = False
    ActiveCell.FormulaR1C1 = EntryDate
    ActiveCell.Select
    Selection.Copy
    Range(Selection, Selection.End(xlDown)).Select
    ActiveSheet.Paste
    Selection.NumberFormat = "YYYYMMDD hh:mm:ss AM/PM"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "=IF(CELL(""format"", [@[Variable Value]])=""D4"", TEXT([@[Variable Value]], ""yyyy-MM-dd""), [@[Variable Value]])"
    
    'END Add EntryDate and EntryBy
    
    'START Save file
    Range(TableName & "[#All]").Select
    Selection.Copy
    Workbooks.Add
    
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
    Application.CutCopyMode = False
    ActiveSheet.ListObjects.Add(xlSrcRange, Selection.CurrentRegion, , xlYes).Name = _
        "Table1"

    Application.DisplayAlerts = False
    
    ActiveWorkbook.SaveAs Filename:= _
        sharePointURL + TimeStamp + "_BRAT" + TableName + "_" + EntryUser + "_" + BRAT_NAME + "_" + VERSION + ".xlsx" _
        , FileFormat:=51
    
    ActiveWindow.Close
    
    'Remove EntryBy
    Range(TableName & "[[#Headers],['EntryBy]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    'Remove EntryTime
    Range(TableName & "[[#Headers],['EntryDate]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    'Remove VariableValueExport
    Range(TableName & "[[#Headers],['VariableValueExport]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    
    'END Save file
    Sheets("Loss Listing").Select
    Application.DisplayAlerts = True
End Sub

Sub ExposureTableExportHandler(EntryDate, EntryUser, TableName, TimeStamp, sharePointURL, BRAT_NAME, VERSION)
    Sheets("Export Data").Select
    
    Dim headersRowNumber As Integer
    Range(TableName + "[[#Headers],['UploadID]]").Select
        headersRowNumber = ActiveCell.Row
        
    Dim col As Variant

    With Sheets("Export Data") '<--| reference relevant worksheet
        col = Application.Match("EntryBy", .Rows(headersRowNumber), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With

    With Sheets("Export Data") '<--| reference relevant worksheet
        col = Application.Match("EntryDate", .Rows(headersRowNumber), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With

    With Sheets("Export Data") '<--| reference relevant worksheet
        col = Application.Match("StartDateExport", .Rows(headersRowNumber), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With
    
    Range(TableName).Select
    'START Add EntryDate and EntryBy
    Selection.End(xlToRight).Offset(-1, 1).Select
    
    ActiveCell.EntireColumn.Select
    ActiveCell.Activate

    Selection.Insert Shift:=xlToRight
    Selection.Insert Shift:=xlToRight
    Selection.Insert Shift:=xlToRight
    
    Range(TableName).Select
    Selection.End(xlToRight).Offset(-1, 1).Select
    
    Application.CutCopyMode = False
    ActiveCell.FormulaR1C1 = "EntryBy"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "EntryDate"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "StartDateExport"
    
    'Values
    ActiveCell.Offset(1, -2).Select
    ActiveCell.FormulaR1C1 = EntryUser
    ActiveCell.Select
    Selection.Copy
    Range(Selection, Selection.End(xlDown)).Select
    ActiveSheet.Paste
    
    ActiveCell.Offset(0, 1).Select
    Application.CutCopyMode = False
    ActiveCell.FormulaR1C1 = EntryDate
    ActiveCell.Select
    Selection.Copy
    Range(Selection, Selection.End(xlDown)).Select
    ActiveSheet.Paste
    Selection.NumberFormat = "YYYYMMDD hh:mm:ss AM/PM"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "=TEXT([@[Start Date]], ""yyyyMMdd"")"
    
    'END Add EntryDate and EntryBy
    
    'START Save file
    Range(TableName & "[#All]").Select
    Selection.Copy
    Workbooks.Add
    
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
    Application.CutCopyMode = False
    ActiveSheet.ListObjects.Add(xlSrcRange, Selection.CurrentRegion, , xlYes).Name = _
        "Table1"

    Application.DisplayAlerts = False
    
    ActiveWorkbook.SaveAs Filename:= _
        sharePointURL + TimeStamp + "_BRAT" + TableName + "_" + EntryUser + "_" + BRAT_NAME + "_" + VERSION + ".xlsx" _
        , FileFormat:=51
    
    ActiveWindow.Close
    
    'Remove EntryBy
    Range(TableName & "[[#Headers],['EntryBy]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    'Remove EntryTime
    Range(TableName & "[[#Headers],['EntryDate]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    'Remove Start Date Export
    Range(TableName & "[[#Headers],['StartDateExport]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    
    'END Save file
    Sheets("Loss Listing").Select
    Application.DisplayAlerts = True
End Sub

Sub DataExportHandler(EntryDate, EntryUser, TableName, TimeStamp, sharePointURL, BRAT_NAME, VERSION)
    Sheets("Export Data").Select
    
    Dim headersRowNumber As Integer
    Range(TableName + "[[#Headers],['UploadID]]").Select
        headersRowNumber = ActiveCell.Row
        
    Dim col As Variant

    With Sheets("Export Data") '<--| reference relevant worksheet
        col = Application.Match("EntryBy", .Rows(4), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With

    With Sheets("Export Data") '<--| reference relevant worksheet
        col = Application.Match("EntryDate", .Rows(4), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With
    
    Range(TableName).Select
    'START Add EntryDate and EntryBy
    Selection.End(xlToRight).Offset(-1, 1).Select
    
    ActiveCell.EntireColumn.Select
    ActiveCell.Activate

    Selection.Insert Shift:=xlToRight
    Selection.Insert Shift:=xlToRight
    
    Range(TableName).Select
    Selection.End(xlToRight).Offset(-1, 1).Select
    
    Application.CutCopyMode = False
    ActiveCell.FormulaR1C1 = "EntryBy"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "EntryDate"
    
    'Values
    ActiveCell.Offset(1, -1).Select
    ActiveCell.FormulaR1C1 = EntryUser
    ActiveCell.Select
    Selection.Copy
    Range(Selection, Selection.End(xlDown)).Select
    ActiveSheet.Paste
    
    ActiveCell.Offset(0, 1).Select
    Application.CutCopyMode = False
    ActiveCell.FormulaR1C1 = EntryDate
    ActiveCell.Select
    Selection.Copy
    Range(Selection, Selection.End(xlDown)).Select
    ActiveSheet.Paste
    Selection.NumberFormat = "YYYYMMDD hh:mm:ss AM/PM"
    
    'END Add EntryDate and EntryBy
    
    'START Save file
    Range(TableName & "[#All]").Select
    Selection.Copy
    Workbooks.Add
    
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
    Application.CutCopyMode = False
    ActiveSheet.ListObjects.Add(xlSrcRange, Selection.CurrentRegion, , xlYes).Name = _
        "Table1"

    Application.DisplayAlerts = False
    
    ActiveWorkbook.SaveAs Filename:= _
        sharePointURL + TimeStamp + "_BRAT" + TableName + "_" + EntryUser + "_" + BRAT_NAME + "_" + VERSION + ".xlsx" _
        , FileFormat:=51
    
    ActiveWindow.Close
    
    'Remove EntryBy
    Range(TableName & "[[#Headers],['EntryBy]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    'Remove EntryTime
    Range(TableName & "[[#Headers],['EntryDate]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    
    'END Save file
    Sheets("Loss Listing").Select
    Application.DisplayAlerts = True
End Sub

Sub LossListingTableHandler(sharePointURL, BRAT_NAME, VERSION)
    
    Application.Calculation = xlCalculationManual
    Range("C:M").EntireColumn.Hidden = False
        
    Dim CURRENT_USER As String
        CURRENT_USER = Application.UserName
    Dim TimeStamp As String
        TimeStamp = Format(Now(), "yyyyMMddhhmmss")
    Dim filePat As String
        filePath = Application.ActiveWorkbook.FullName
    Sheets("Loss Listing").Select
    Dim headersRowNumber As Integer
    
    'START Add row count
    Range("LossTable[[#Headers],['#]]").Select
        headersRowNumber = ActiveCell.Row
    ActiveCell.Offset(1, 0).Select
    Selection.ListObject.ListRows.Add (1)
    ActiveCell.FormulaR1C1 = "0"
    Range("LossTable[[#Headers],['Coverage]]").Select
    ActiveCell.Offset(1, 0).Select
    ActiveCell.FormulaR1C1 = "PL"
    Range("LossTable[[#Headers],['UploadID]]").Select
    ActiveCell.Offset(1, 0).Select
    'To get number of rows populated using Coverage column as reference
    Dim myColumn As ListColumn
    Set myColumn = Sheets("Loss Listing").ListObjects("LossTable").ListColumns("Coverage")
    Dim UsedRows As Long
    UsedRows = Application.CountA(myColumn.DataBodyRange)
    ActiveCell.FormulaR1C1 = UsedRows - 1
    'END row count
    
    'START Filter out blank rows based on Coverage
    ActiveSheet.ListObjects("LossTable").Range.AutoFilter Field:=14, Criteria1 _
        :="<>"
    'END Filter out blank rows based on Coverage
    Range("LossTable[[#Headers],['#]]").Select
    ActiveCell.FormulaR1C1 = "BRATRowNumber"
    
    'START Remove Extra Columns if exists
    Dim col As Variant

    With Sheets("Loss Listing") '<--| reference relevant worksheet
        col = Application.Match("Evaluation Date Import", .Rows(headersRowNumber), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With

    With Sheets("Loss Listing") '<--| reference relevant worksheet
        col = Application.Match("Report Date Import", .Rows(headersRowNumber), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With
    
    With Sheets("Loss Listing") '<--| reference relevant worksheet
        col = Application.Match("Loss or Accident Date Import", .Rows(headersRowNumber), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With
    
     With Sheets("Loss Listing") '<--| reference relevant worksheet
        col = Application.Match("Closed Date Import", .Rows(headersRowNumber), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With
    
    With Sheets("Loss Listing") '<--| reference relevant worksheet
        col = Application.Match("Experience Date Import", .Rows(headersRowNumber), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With
    
    With Sheets("Loss Listing") '<--| reference relevant worksheet
        col = Application.Match("EntryBy", .Rows(headersRowNumber), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With
    
    With Sheets("Loss Listing") '<--| reference relevant worksheet
        col = Application.Match("EntryDate", .Rows(headersRowNumber), 0) '<--| try searching its row 1 for wanted header text
    If Not IsError(col) Then .Columns(col).Delete '<--| if found then delete its entire column
    End With
    'END Remove Extra Columns if exists
    
    
    'START Adding new columns
    
    'Headers
    Selection.End(xlToRight).Offset(0, 1).Select
    Application.CutCopyMode = False
    ActiveCell.FormulaR1C1 = "Evaluation Date Import"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "Report Date Import"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "Loss or Accident Date Import"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "Closed Date Import"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "Experience Date Import"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "EntryBy"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "EntryDate"
    
    'Values
    ActiveCell.Offset(1, -6).Select
    ActiveCell.FormulaR1C1 = "=TEXT([@[Evaluation Date]], ""yyyyMMdd"")"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "=TEXT([@[Report Date]], ""yyyyMMdd"")"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "=TEXT([@[Loss or Accident Date Import]], ""yyyyMMdd"")"
     
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "=TEXT([@[Closed Date Import]], ""yyyyMMdd"")"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = "=TEXT([@[Experience Date Import]], ""yyyyMMdd"")"
    
    ActiveCell.Offset(0, 1).Select
    ActiveCell.FormulaR1C1 = Application.UserName
    ActiveCell.Select
    Selection.Copy
    Range(Selection, Selection.End(xlDown)).Select
    ActiveSheet.Paste
    
    ActiveCell.Offset(0, 1).Select
    Application.CutCopyMode = False
    ActiveCell.FormulaR1C1 = Format(Now, "YYYYMMDD hh:mm:ss  AM/PM")
    ActiveCell.Select
    Selection.Copy
    Range(Selection, Selection.End(xlDown)).Select
    ActiveSheet.Paste
    Selection.NumberFormat = "YYYYMMDD hh:mm:ss AM/PM"
    'END Adding new columns
    
    Range("LossTable[#All]").Select
    
    Selection.Copy
    Workbooks.Add
    'ActiveSheet.Paste
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
    Application.CutCopyMode = False
    ActiveSheet.ListObjects.Add(xlSrcRange, Selection.CurrentRegion, , xlYes).Name = _
        "LossTable"
        
    Application.DisplayAlerts = False
    ActiveWorkbook.SaveAs Filename:= _
        sharePointURL + TimeStamp + "_BRATForLosses_" + CURRENT_USER + "_" + BRAT_NAME + "_" + VERSION + ".xlsx" _
        , FileFormat:=51
    
    ActiveWindow.Close
    
    'Remove EntryBy
    Range("LossTable[[#Headers],['EntryDate]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    'Remove EntryTime
    Range("LossTable[[#Headers],['EntryBy]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    'Remove Evaluation Date Import
    Range("LossTable[[#Headers],['Evaluation Date Import]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    'Remove Report Date Import
    Range("LossTable[[#Headers],['Report Date Import]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    'Remove Loss or Accident Date Import
    Range("LossTable[[#Headers],['Loss or Accident Date Import]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    'Remove Closed Date Import
    Range("LossTable[[#Headers],['Closed Date Import]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    'Remove Experience Date Import
    Range("LossTable[[#Headers],['Experience Date Import]]").Select
    ActiveCell.EntireColumn.Select
    Selection.Delete Shift:=xlToLeft
    
    Range("LossTable[[#Headers],['BRATRowNumber]]").Select
    ActiveCell.FormulaR1C1 = "#"
    
    'START Fromat dates back
    'Range("LossTable[[#All],[Evaluation Date]]").Select
    'Selection.NumberFormat = "m/d/yyyy"
    'Range("LossTable[[#All],[Report Date]]").Select
    'Selection.NumberFormat = "m/d/yyyy"
    'Range("LossTable[[#All],[Loss or Accident Date]]").Select
    'Selection.NumberFormat = "m/d/yyyy"
    'Range("LossTable[[#All],[Closed Date]]").Select
    'Selection.NumberFormat = "m/d/yyyy"
    'Range("LossTable[[#All],[Experience Date]]").Select
    'Selection.NumberFormat = "m/d/yyyy"
    'END Fromat dates back
    
    'DELETE ROW COUNT
    ActiveSheet.ListObjects("LossTable").Range.AutoFilter Field:=14
    ActiveCell.Offset(1, 0).Select
    Selection.ListObject.ListRows(1).Delete
    
    
    Application.DisplayAlerts = True
    Range("C:M").EntireColumn.Hidden = True
    
End Sub
